#include "LOAD_LEV.H"

#include "CD.H"
#include "GAMEFLOW.H"
#include "GPU.H"
#include "MALLOC.H"
#include "PROFILE.H"

#include <stddef.h>
#include <assert.h>

#if 0
#include <limits>
#endif

#ifndef SHRT_MAX
	#define SHRT_MAX 32767
#endif

unsigned char LtLoadingBarEnabled;
unsigned char LoadingBarEnabled;
unsigned char _first_time_ever;
short DelRotAng;
struct STASHEDOBJ* cur_stashed_object;
struct STASHEDDAT* cur_stashed_matrix;
int num_objects_stashed;
struct STASHEDOBJ stashed_objects_list[128];
struct STASHEDDAT stashed_matrix_list[240];
unsigned char char_anim;
unsigned char OurSqrt[1024];
struct WATERTAB WaterTable[22][64];
struct MATRIX3D* Matrix;

unsigned short SqrtTable[210] =
{
	0x1000, 0x1F10, 0x101F, 0x3F10, 0x103F, 0x5E10, 0x105E, 0x7E10, 0x107E, 0x9C10, 
	0x109C, 0xBB10, 0x10BB, 0xDA10, 0x10DA, 0xF810, 0x10F8, 0x1610, 0x1116, 0x3411, 
	0x1134, 0x5211, 0x1152, 0x6F11, 0x116F, 0x8C11, 0x118C, 0xA911, 0x11A9, 0xC611, 
	0x11C6, 0xE311, 0x11E3, 0x0011, 0x1200, 0x1C12, 0x121C, 0x3812, 0x1238, 0x5412, 
	0x1254, 0x7012, 0x1270, 0x8C12, 0x128C, 0xA712, 0x12A7, 0xC212, 0x12C2, 0xDE12, 
	0x12DE, 0xF912, 0x12F9, 0x1412, 0x1314, 0x2E13, 0x132E, 0x4913, 0x1349, 0x6413, 
	0x1364, 0x7E13, 0x137E, 0x9813, 0x1398, 0xB213, 0x13B2, 0xCC13, 0x13CC, 0xE613, 
	0x13E6, 0x0013, 0x1400, 0x1914, 0x1419, 0x3214, 0x1432, 0x4C14, 0x144C, 0x6514, 
	0x1465, 0x7E14, 0x147E, 0x9714, 0x1497, 0xB014, 0x14B0, 0xC814, 0x14C8, 0xE114, 
	0x14E1, 0xF914, 0x14F9, 0x1214, 0x1512, 0x2A15, 0x152A, 0x4215, 0x1542, 0x5A15, 
	0x155A, 0x7215, 0x1572, 0x8A15, 0x158A, 0xA215, 0x15A2, 0xB915, 0x15B9, 0xD115, 
	0x15D1, 0xE815, 0x15E8, 0x0015, 0x1600, 0x1716, 0x1617, 0x2E16, 0x162E, 0x4516, 
	0x1645, 0x5C16, 0x165C, 0x7316, 0x1673, 0x8916, 0x1689, 0xA016, 0x16A0, 0xB716, 
	0x16B7, 0xCD16, 0x16CD, 0xE416, 0x16E4, 0xFA16, 0x16FA, 0x1016, 0x1710, 0x2617, 
	0x1726, 0x3C17, 0x173C, 0x5217, 0x1752, 0x6817, 0x1768, 0x7E17, 0x177E, 0x9417, 
	0x1794, 0xAA17, 0x17AA, 0xBF17, 0x17BF, 0xD517, 0x17D5, 0xEA17, 0x17EA, 0x0017, 
	0x1800, 0x1518, 0x1815, 0x2A18, 0x182A, 0x3F18, 0x183F, 0x5418, 0x1854, 0x6918, 
	0x1869, 0x7E18, 0x187E, 0x9318, 0x1893, 0xA818, 0x18A8, 0xBD18, 0x18BD, 0xD118, 
	0x18D1, 0xE618, 0x18E6, 0xFA18, 0x18FA, 0x0F18, 0x190F, 0x2319, 0x1923, 0x3819, 
	0x1938, 0x4C19, 0x194C, 0x6019, 0x1960, 0x7419, 0x1974, 0x8819, 0x1988, 0x9C19, 
	0x199C, 0xB019, 0x19B0, 0xC419, 0x19C4, 0xD819, 0x19D8, 0xEC19, 0x19EC, 0x0019
};
unsigned short ScalarTable[198] =
{
	0x1000, 0xE010, 0x0FE0, 0xC10F, 0x0FC1, 0xA30F, 0x0FA3, 0x850F, 0x0F85, 0x680F, 
	0x0F68, 0x4C0F, 0x0F4C, 0x300F, 0x0F30, 0x150F, 0x0F15, 0xFB0F, 0x0EFB, 0xE10E, 
	0x0EE1, 0xC70E, 0x0EC7, 0xAE0E, 0x0EAE, 0x960E, 0x0E96, 0x7E0E, 0x0E7E, 0x660E, 
	0x0E66, 0x4F0E, 0x0E4F, 0x380E, 0x0E38, 0x220E, 0x0E22, 0x0C0E, 0x0E0C, 0xF70E, 
	0x0DF7, 0xE20D, 0x0DE2, 0xCD0D, 0x0DCD, 0xB90D, 0x0DB9, 0xA50D, 0x0DA5, 0x910D, 
	0x0D91, 0x7E0D, 0x0D7E, 0x6B0D, 0x0D6B, 0x580D, 0x0D58, 0x450D, 0x0D45, 0x330D, 
	0x0D33, 0x210D, 0x0D21, 0x100D, 0x0D10, 0xFF0D, 0x0CFF, 0xEE0C, 0x0CEE, 0xDD0C, 
	0x0CDD, 0xCC0C, 0x0CCC, 0xBC0C, 0x0CBC, 0xAC0C, 0x0CAC, 0x9C0C, 0x0C9C, 0x8D0C, 
	0x0C8D, 0x7D0C, 0x0C7D, 0x6E0C, 0x0C6E, 0x5F0C, 0x0C5F, 0x510C, 0x0C51, 0x420C, 
	0x0C42, 0x340C, 0x0C34, 0x260C, 0x0C26, 0x180C, 0x0C18, 0x0A0C, 0x0C0A, 0xFD0C, 
	0x0BFD, 0xEF0B, 0x0BEF, 0xE20B, 0x0BE2, 0xD50B, 0x0BD5, 0xC80B, 0x0BC8, 0xBB0B, 
	0x0BBB, 0xAF0B, 0x0BAF, 0xA20B, 0x0BA2, 0x960B, 0x0B96, 0x8A0B, 0x0B8A, 0x7E0B, 
	0x0B7E, 0x720B, 0x0B72, 0x670B, 0x0B67, 0x5B0B, 0x0B5B, 0x500B, 0x0B50, 0x450B, 
	0x0B45, 0x390B, 0x0B39, 0x2E0B, 0x0B2E, 0x240B, 0x0B24, 0x190B, 0x0B19, 0x0E0B, 
	0x0B0E, 0x040B, 0x0B04, 0xF90B, 0x0AF9, 0xEF0A, 0x0AEF, 0xE50A, 0x0AE5, 0xDB0A, 
	0x0ADB, 0xD10A, 0x0AD1, 0xC70A, 0x0AC7, 0xBD0A, 0x0ABD, 0xB40A, 0x0AB4, 0xAA0A, 
	0x0AAA, 0xA10A, 0x0AA1, 0x970A, 0x0A97, 0x8E0A, 0x0A8E, 0x850A, 0x0A85, 0x7C0A, 
	0x0A7C, 0x730A, 0x0A73, 0x6A0A, 0x0A6A, 0x610A, 0x0A61, 0x590A, 0x0A59, 0x500A, 
	0x0A50, 0x470A, 0x0A47, 0x3F0A, 0x0A3F, 0x370A, 0x0A37, 0x2E0A, 0x0A2E, 0x260A, 
	0x0A26, 0x1E0A, 0x0A1E, 0x160A, 0x0A16, 0x0E0A, 0x0A0E, 0x060A
};

struct MATRIX3D iMatrixStack[32];
struct SVECTOR CamRot;
struct MATRIX3D* iMatrix;
unsigned short MatrixSP;
struct MATRIX3D MatrixStack[32];
long iFrac;
long iRate;
long iAmbientR;
long iAmbientG;
long iAmbientB;

long atanOctantTab[8] =
{
	0x00000000, 0x00000000, 0xC0000000, 0xFFC00000, 0xFFFFC000, 0x01FFFFC0, 0x0001FFFF, 0xFF0001FF
};

short atanTab[2050] =
{
	0x0000, 0x0500, 0x0005, 0x0A00, 0x000A, 0x0F00, 0x000F, 0x1400, 0x0014, 0x1900,
	0x0019, 0x1F00, 0x001F, 0x2400, 0x0024, 0x2900, 0x0029, 0x2E00, 0x002E, 0x3300,
	0x0033, 0x3800, 0x0038, 0x3D00, 0x003D, 0x4200, 0x0042, 0x4700, 0x0047, 0x4C00,
	0x004C, 0x5100, 0x0051, 0x5700, 0x0057, 0x5C00, 0x005C, 0x6100, 0x0061, 0x6600,
	0x0066, 0x6B00, 0x006B, 0x7000, 0x0070, 0x7500, 0x0075, 0x7A00, 0x007A, 0x7F00,
	0x007F, 0x8400, 0x0084, 0x8A00, 0x008A, 0x8F00, 0x008F, 0x9400, 0x0094, 0x9900,
	0x0099, 0x9E00, 0x009E, 0xA300, 0x00A3, 0xA800, 0x00A8, 0xAD00, 0x00AD, 0xB200,
	0x00B2, 0xB700, 0x00B7, 0xBC00, 0x00BC, 0xC200, 0x00C2, 0xC700, 0x00C7, 0xCC00,
	0x00CC, 0xD100, 0x00D1, 0xD600, 0x00D6, 0xDB00, 0x00DB, 0xE000, 0x00E0, 0xE500,
	0x00E5, 0xEA00, 0x00EA, 0xEF00, 0x00EF, 0xF400, 0x00F4, 0xFA00, 0x00FA, 0xFF00,
	0x00FF, 0x0400, 0x0104, 0x0901, 0x0109, 0x0E01, 0x010E, 0x1301, 0x0113, 0x1801,
	0x0118, 0x1D01, 0x011D, 0x2201, 0x0122, 0x2701, 0x0127, 0x2C01, 0x012C, 0x3101,
	0x0131, 0x3701, 0x0137, 0x3C01, 0x013C, 0x4101, 0x0141, 0x4601, 0x0146, 0x4B01,
	0x014B, 0x5001, 0x0150, 0x5501, 0x0155, 0x5A01, 0x015A, 0x5F01, 0x015F, 0x6401,
	0x0164, 0x6901, 0x0169, 0x6F01, 0x016F, 0x7401, 0x0174, 0x7901, 0x0179, 0x7E01,
	0x017E, 0x8301, 0x0183, 0x8801, 0x0188, 0x8D01, 0x018D, 0x9201, 0x0192, 0x9701,
	0x0197, 0x9C01, 0x019C, 0xA101, 0x01A1, 0xA601, 0x01A6, 0xAC01, 0x01AC, 0xB101,
	0x01B1, 0xB601, 0x01B6, 0xBB01, 0x01BB, 0xC001, 0x01C0, 0xC501, 0x01C5, 0xCA01,
	0x01CA, 0xCF01, 0x01CF, 0xD401, 0x01D4, 0xD901, 0x01D9, 0xDE01, 0x01DE, 0xE301,
	0x01E3, 0xE901, 0x01E9, 0xEE01, 0x01EE, 0xF301, 0x01F3, 0xF801, 0x01F8, 0xFD01,
	0x01FD, 0x0201, 0x0202, 0x0702, 0x0207, 0x0C02, 0x020C, 0x1102, 0x0211, 0x1602,
	0x0216, 0x1B02, 0x021B, 0x2002, 0x0220, 0x2602, 0x0226, 0x2B02, 0x022B, 0x3002,
	0x0230, 0x3502, 0x0235, 0x3A02, 0x023A, 0x3F02, 0x023F, 0x4402, 0x0244, 0x4902,
	0x0249, 0x4E02, 0x024E, 0x5302, 0x0253, 0x5802, 0x0258, 0x5D02, 0x025D, 0x6202,
	0x0262, 0x6802, 0x0268, 0x6D02, 0x026D, 0x7202, 0x0272, 0x7702, 0x0277, 0x7C02,
	0x027C, 0x8102, 0x0281, 0x8602, 0x0286, 0x8B02, 0x028B, 0x9002, 0x0290, 0x9502,
	0x0295, 0x9A02, 0x029A, 0x9F02, 0x029F, 0xA402, 0x02A4, 0xA902, 0x02A9, 0xAF02,
	0x02AF, 0xB402, 0x02B4, 0xB902, 0x02B9, 0xBE02, 0x02BE, 0xC302, 0x02C3, 0xC802,
	0x02C8, 0xCD02, 0x02CD, 0xD202, 0x02D2, 0xD702, 0x02D7, 0xDC02, 0x02DC, 0xE102,
	0x02E1, 0xE602, 0x02E6, 0xEB02, 0x02EB, 0xF002, 0x02F0, 0xF602, 0x02F6, 0xFB02,
	0x02FB, 0x0002, 0x0300, 0x0503, 0x0305, 0x0A03, 0x030A, 0x0F03, 0x030F, 0x1403,
	0x0314, 0x1903, 0x0319, 0x1E03, 0x031E, 0x2303, 0x0323, 0x2803, 0x0328, 0x2D03,
	0x032D, 0x3203, 0x0332, 0x3703, 0x0337, 0x3C03, 0x033C, 0x4103, 0x0341, 0x4703,
	0x0347, 0x4C03, 0x034C, 0x5103, 0x0351, 0x5603, 0x0356, 0x5B03, 0x035B, 0x6003,
	0x0360, 0x6503, 0x0365, 0x6A03, 0x036A, 0x6F03, 0x036F, 0x7403, 0x0374, 0x7903,
	0x0379, 0x7E03, 0x037E, 0x8303, 0x0383, 0x8803, 0x0388, 0x8D03, 0x038D, 0x9203,
	0x0392, 0x9703, 0x0397, 0x9C03, 0x039C, 0xA203, 0x03A2, 0xA703, 0x03A7, 0xAC03,
	0x03AC, 0xB103, 0x03B1, 0xB603, 0x03B6, 0xBB03, 0x03BB, 0xC003, 0x03C0, 0xC503,
	0x03C5, 0xCA03, 0x03CA, 0xCF03, 0x03CF, 0xD403, 0x03D4, 0xD903, 0x03D9, 0xDE03,
	0x03DE, 0xE303, 0x03E3, 0xE803, 0x03E8, 0xED03, 0x03ED, 0xF203, 0x03F2, 0xF703,
	0x03F7, 0xFC03, 0x03FC, 0x0103, 0x0401, 0x0704, 0x0407, 0x0C04, 0x040C, 0x1104,
	0x0411, 0x1604, 0x0416, 0x1B04, 0x041B, 0x2004, 0x0420, 0x2504, 0x0425, 0x2A04,
	0x042A, 0x2F04, 0x042F, 0x3404, 0x0434, 0x3904, 0x0439, 0x3E04, 0x043E, 0x4304,
	0x0443, 0x4804, 0x0448, 0x4D04, 0x044D, 0x5204, 0x0452, 0x5704, 0x0457, 0x5C04,
	0x045C, 0x6104, 0x0461, 0x6604, 0x0466, 0x6B04, 0x046B, 0x7004, 0x0470, 0x7504,
	0x0475, 0x7A04, 0x047A, 0x7F04, 0x047F, 0x8404, 0x0484, 0x8904, 0x0489, 0x8E04,
	0x048E, 0x9404, 0x0494, 0x9904, 0x0499, 0x9E04, 0x049E, 0xA304, 0x04A3, 0xA804,
	0x04A8, 0xAD04, 0x04AD, 0xB204, 0x04B2, 0xB704, 0x04B7, 0xBC04, 0x04BC, 0xC104,
	0x04C1, 0xC604, 0x04C6, 0xCB04, 0x04CB, 0xD004, 0x04D0, 0xD504, 0x04D5, 0xDA04,
	0x04DA, 0xDF04, 0x04DF, 0xE404, 0x04E4, 0xE904, 0x04E9, 0xEE04, 0x04EE, 0xF304,
	0x04F3, 0xF804, 0x04F8, 0xFD04, 0x04FD, 0x0204, 0x0502, 0x0705, 0x0507, 0x0C05,
	0x050C, 0x1105, 0x0511, 0x1605, 0x0516, 0x1B05, 0x051B, 0x2005, 0x0520, 0x2505,
	0x0525, 0x2A05, 0x052A, 0x2F05, 0x052F, 0x3405, 0x0534, 0x3905, 0x0539, 0x3E05,
	0x053E, 0x4305, 0x0543, 0x4805, 0x0548, 0x4D05, 0x054D, 0x5205, 0x0552, 0x5705,
	0x0557, 0x5C05, 0x055C, 0x6105, 0x0561, 0x6605, 0x0566, 0x6B05, 0x056B, 0x7005,
	0x0570, 0x7505, 0x0575, 0x7A05, 0x057A, 0x7F05, 0x057F, 0x8405, 0x0584, 0x8905,
	0x0589, 0x8E05, 0x058E, 0x9305, 0x0593, 0x9805, 0x0598, 0x9D05, 0x059D, 0xA205,
	0x05A2, 0xA705, 0x05A7, 0xAC05, 0x05AC, 0xB105, 0x05B1, 0xB605, 0x05B6, 0xBB05,
	0x05BB, 0xC005, 0x05C0, 0xC505, 0x05C5, 0xCA05, 0x05CA, 0xCF05, 0x05CF, 0xD405,
	0x05D4, 0xD905, 0x05D9, 0xDE05, 0x05DE, 0xE305, 0x05E3, 0xE805, 0x05E8, 0xED05,
	0x05ED, 0xF205, 0x05F2, 0xF705, 0x05F7, 0xFC05, 0x05FC, 0x0105, 0x0601, 0x0606,
	0x0606, 0x0B06, 0x060B, 0x1006, 0x0610, 0x1506, 0x0615, 0x1A06, 0x061A, 0x1F06,
	0x061F, 0x2406, 0x0624, 0x2906, 0x0629, 0x2E06, 0x062E, 0x3306, 0x0633, 0x3806,
	0x0638, 0x3D06, 0x063D, 0x4206, 0x0642, 0x4706, 0x0647, 0x4C06, 0x064C, 0x5106,
	0x0651, 0x5606, 0x0656, 0x5B06, 0x065B, 0x6006, 0x0660, 0x6506, 0x0665, 0x6A06,
	0x066A, 0x6E06, 0x066E, 0x7306, 0x0673, 0x7806, 0x0678, 0x7D06, 0x067D, 0x8206,
	0x0682, 0x8706, 0x0687, 0x8C06, 0x068C, 0x9106, 0x0691, 0x9606, 0x0696, 0x9B06,
	0x069B, 0xA006, 0x06A0, 0xA506, 0x06A5, 0xAA06, 0x06AA, 0xAF06, 0x06AF, 0xB406,
	0x06B4, 0xB906, 0x06B9, 0xBE06, 0x06BE, 0xC306, 0x06C3, 0xC806, 0x06C8, 0xCD06,
	0x06CD, 0xD206, 0x06D2, 0xD706, 0x06D7, 0xDC06, 0x06DC, 0xE106, 0x06E1, 0xE506,
	0x06E5, 0xEA06, 0x06EA, 0xEF06, 0x06EF, 0xF406, 0x06F4, 0xF906, 0x06F9, 0xFE06,
	0x06FE, 0x0306, 0x0703, 0x0807, 0x0708, 0x0D07, 0x070D, 0x1207, 0x0712, 0x1707,
	0x0717, 0x1C07, 0x071C, 0x2107, 0x0721, 0x2607, 0x0726, 0x2B07, 0x072B, 0x3007,
	0x0730, 0x3507, 0x0735, 0x3907, 0x0739, 0x3E07, 0x073E, 0x4307, 0x0743, 0x4807,
	0x0748, 0x4D07, 0x074D, 0x5207, 0x0752, 0x5707, 0x0757, 0x5C07, 0x075C, 0x6107,
	0x0761, 0x6607, 0x0766, 0x6B07, 0x076B, 0x7007, 0x0770, 0x7507, 0x0775, 0x7A07,
	0x077A, 0x7E07, 0x077E, 0x8307, 0x0783, 0x8807, 0x0788, 0x8D07, 0x078D, 0x9207,
	0x0792, 0x9707, 0x0797, 0x9C07, 0x079C, 0xA107, 0x07A1, 0xA607, 0x07A6, 0xAB07,
	0x07AB, 0xB007, 0x07B0, 0xB507, 0x07B5, 0xB907, 0x07B9, 0xBE07, 0x07BE, 0xC307,
	0x07C3, 0xC807, 0x07C8, 0xCD07, 0x07CD, 0xD207, 0x07D2, 0xD707, 0x07D7, 0xDC07,
	0x07DC, 0xE107, 0x07E1, 0xE607, 0x07E6, 0xEB07, 0x07EB, 0xEF07, 0x07EF, 0xF407,
	0x07F4, 0xF907, 0x07F9, 0xFE07, 0x07FE, 0x0307, 0x0803, 0x0808, 0x0808, 0x0D08,
	0x080D, 0x1208, 0x0812, 0x1708, 0x0817, 0x1C08, 0x081C, 0x2008, 0x0820, 0x2508,
	0x0825, 0x2A08, 0x082A, 0x2F08, 0x082F, 0x3408, 0x0834, 0x3908, 0x0839, 0x3E08,
	0x083E, 0x4308, 0x0843, 0x4808, 0x0848, 0x4C08, 0x084C, 0x5108, 0x0851, 0x5608,
	0x0856, 0x5B08, 0x085B, 0x6008, 0x0860, 0x6508, 0x0865, 0x6A08, 0x086A, 0x6F08,
	0x086F, 0x7308, 0x0873, 0x7808, 0x0878, 0x7D08, 0x087D, 0x8208, 0x0882, 0x8708,
	0x0887, 0x8C08, 0x088C, 0x9108, 0x0891, 0x9608, 0x0896, 0x9A08, 0x089A, 0x9F08,
	0x089F, 0xA408, 0x08A4, 0xA908, 0x08A9, 0xAE08, 0x08AE, 0xB308, 0x08B3, 0xB808,
	0x08B8, 0xBD08, 0x08BD, 0xC108, 0x08C1, 0xC608, 0x08C6, 0xCB08, 0x08CB, 0xD008,
	0x08D0, 0xD508, 0x08D5, 0xDA08, 0x08DA, 0xDF08, 0x08DF, 0xE308, 0x08E3, 0xE808,
	0x08E8, 0xED08, 0x08ED, 0xF208, 0x08F2, 0xF708, 0x08F7, 0xFC08, 0x08FC, 0x0108,
	0x0901, 0x0509, 0x0905, 0x0A09, 0x090A, 0x0F09, 0x090F, 0x1409, 0x0914, 0x1909,
	0x0919, 0x1E09, 0x091E, 0x2209, 0x0922, 0x2709, 0x0927, 0x2C09, 0x092C, 0x3109,
	0x0931, 0x3609, 0x0936, 0x3B09, 0x093B, 0x3F09, 0x093F, 0x4409, 0x0944, 0x4909,
	0x0949, 0x4E09, 0x094E, 0x5309, 0x0953, 0x5809, 0x0958, 0x5C09, 0x095C, 0x6109,
	0x0961, 0x6609, 0x0966, 0x6B09, 0x096B, 0x7009, 0x0970, 0x7509, 0x0975, 0x7909,
	0x0979, 0x7E09, 0x097E, 0x8309, 0x0983, 0x8809, 0x0988, 0x8D09, 0x098D, 0x9209,
	0x0992, 0x9609, 0x0996, 0x9B09, 0x099B, 0xA009, 0x09A0, 0xA509, 0x09A5, 0xAA09,
	0x09AA, 0xAE09, 0x09AE, 0xB309, 0x09B3, 0xB809, 0x09B8, 0xBD09, 0x09BD, 0xC209,
	0x09C2, 0xC609, 0x09C6, 0xCB09, 0x09CB, 0xD009, 0x09D0, 0xD509, 0x09D5, 0xDA09,
	0x09DA, 0xDE09, 0x09DE, 0xE309, 0x09E3, 0xE809, 0x09E8, 0xED09, 0x09ED, 0xF209,
	0x09F2, 0xF609, 0x09F6, 0xFB09, 0x09FB, 0x0009, 0x0A00, 0x050A, 0x0A05, 0x0A0A,
	0x0A0A, 0x0E0A, 0x0A0E, 0x130A, 0x0A13, 0x180A, 0x0A18, 0x1D0A, 0x0A1D, 0x220A,
	0x0A22, 0x260A, 0x0A26, 0x2B0A, 0x0A2B, 0x300A, 0x0A30, 0x350A, 0x0A35, 0x390A,
	0x0A39, 0x3E0A, 0x0A3E, 0x430A, 0x0A43, 0x480A, 0x0A48, 0x4D0A, 0x0A4D, 0x510A,
	0x0A51, 0x560A, 0x0A56, 0x5B0A, 0x0A5B, 0x600A, 0x0A60, 0x640A, 0x0A64, 0x690A,
	0x0A69, 0x6E0A, 0x0A6E, 0x730A, 0x0A73, 0x770A, 0x0A77, 0x7C0A, 0x0A7C, 0x810A,
	0x0A81, 0x860A, 0x0A86, 0x8B0A, 0x0A8B, 0x8F0A, 0x0A8F, 0x940A, 0x0A94, 0x990A,
	0x0A99, 0x9E0A, 0x0A9E, 0xA20A, 0x0AA2, 0xA70A, 0x0AA7, 0xAC0A, 0x0AAC, 0xB10A,
	0x0AB1, 0xB50A, 0x0AB5, 0xBA0A, 0x0ABA, 0xBF0A, 0x0ABF, 0xC40A, 0x0AC4, 0xC80A,
	0x0AC8, 0xCD0A, 0x0ACD, 0xD20A, 0x0AD2, 0xD70A, 0x0AD7, 0xDB0A, 0x0ADB, 0xE00A,
	0x0AE0, 0xE50A, 0x0AE5, 0xE90A, 0x0AE9, 0xEE0A, 0x0AEE, 0xF30A, 0x0AF3, 0xF80A,
	0x0AF8, 0xFC0A, 0x0AFC, 0x010A, 0x0B01, 0x060B, 0x0B06, 0x0B0B, 0x0B0B, 0x0F0B,
	0x0B0F, 0x140B, 0x0B14, 0x190B, 0x0B19, 0x1E0B, 0x0B1E, 0x220B, 0x0B22, 0x270B,
	0x0B27, 0x2C0B, 0x0B2C, 0x300B, 0x0B30, 0x350B, 0x0B35, 0x3A0B, 0x0B3A, 0x3F0B,
	0x0B3F, 0x430B, 0x0B43, 0x480B, 0x0B48, 0x4D0B, 0x0B4D, 0x510B, 0x0B51, 0x560B,
	0x0B56, 0x5B0B, 0x0B5B, 0x600B, 0x0B60, 0x640B, 0x0B64, 0x690B, 0x0B69, 0x6E0B,
	0x0B6E, 0x720B, 0x0B72, 0x770B, 0x0B77, 0x7C0B, 0x0B7C, 0x800B, 0x0B80, 0x850B,
	0x0B85, 0x8A0B, 0x0B8A, 0x8F0B, 0x0B8F, 0x930B, 0x0B93, 0x980B, 0x0B98, 0x9D0B,
	0x0B9D, 0xA10B, 0x0BA1, 0xA60B, 0x0BA6, 0xAB0B, 0x0BAB, 0xAF0B, 0x0BAF, 0xB40B,
	0x0BB4, 0xB90B, 0x0BB9, 0xBD0B, 0x0BBD, 0xC20B, 0x0BC2, 0xC70B, 0x0BC7, 0xCB0B,
	0x0BCB, 0xD00B, 0x0BD0, 0xD50B, 0x0BD5, 0xD90B, 0x0BD9, 0xDE0B, 0x0BDE, 0xE30B,
	0x0BE3, 0xE70B, 0x0BE7, 0xEC0B, 0x0BEC, 0xF10B, 0x0BF1, 0xF50B, 0x0BF5, 0xFA0B,
	0x0BFA, 0xFF0B, 0x0BFF, 0x030B, 0x0C03, 0x080C, 0x0C08, 0x0D0C, 0x0C0D, 0x110C,
	0x0C11, 0x160C, 0x0C16, 0x1B0C, 0x0C1B, 0x1F0C, 0x0C1F, 0x240C, 0x0C24, 0x290C,
	0x0C29, 0x2D0C, 0x0C2D, 0x320C, 0x0C32, 0x370C, 0x0C37, 0x3B0C, 0x0C3B, 0x400C,
	0x0C40, 0x450C, 0x0C45, 0x490C, 0x0C49, 0x4E0C, 0x0C4E, 0x530C, 0x0C53, 0x570C,
	0x0C57, 0x5C0C, 0x0C5C, 0x600C, 0x0C60, 0x650C, 0x0C65, 0x6A0C, 0x0C6A, 0x6E0C,
	0x0C6E, 0x730C, 0x0C73, 0x780C, 0x0C78, 0x7C0C, 0x0C7C, 0x810C, 0x0C81, 0x860C,
	0x0C86, 0x8A0C, 0x0C8A, 0x8F0C, 0x0C8F, 0x930C, 0x0C93, 0x980C, 0x0C98, 0x9D0C,
	0x0C9D, 0xA10C, 0x0CA1, 0xA60C, 0x0CA6, 0xAB0C, 0x0CAB, 0xAF0C, 0x0CAF, 0xB40C,
	0x0CB4, 0xB80C, 0x0CB8, 0xBD0C, 0x0CBD, 0xC20C, 0x0CC2, 0xC60C, 0x0CC6, 0xCB0C,
	0x0CCB, 0xCF0C, 0x0CCF, 0xD40C, 0x0CD4, 0xD90C, 0x0CD9, 0xDD0C, 0x0CDD, 0xE20C,
	0x0CE2, 0xE60C, 0x0CE6, 0xEB0C, 0x0CEB, 0xF00C, 0x0CF0, 0xF40C, 0x0CF4, 0xF90C,
	0x0CF9, 0xFD0C, 0x0CFD, 0x020C, 0x0D02, 0x070D, 0x0D07, 0x0B0D, 0x0D0B, 0x100D,
	0x0D10, 0x140D, 0x0D14, 0x190D, 0x0D19, 0x1E0D, 0x0D1E, 0x220D, 0x0D22, 0x270D,
	0x0D27, 0x2B0D, 0x0D2B, 0x300D, 0x0D30, 0x340D, 0x0D34, 0x390D, 0x0D39, 0x3E0D,
	0x0D3E, 0x420D, 0x0D42, 0x470D, 0x0D47, 0x4B0D, 0x0D4B, 0x500D, 0x0D50, 0x540D,
	0x0D54, 0x590D, 0x0D59, 0x5E0D, 0x0D5E, 0x620D, 0x0D62, 0x670D, 0x0D67, 0x6B0D,
	0x0D6B, 0x700D, 0x0D70, 0x740D, 0x0D74, 0x790D, 0x0D79, 0x7D0D, 0x0D7D, 0x820D,
	0x0D82, 0x870D, 0x0D87, 0x8B0D, 0x0D8B, 0x900D, 0x0D90, 0x940D, 0x0D94, 0x990D,
	0x0D99, 0x9D0D, 0x0D9D, 0xA20D, 0x0DA2, 0xA60D, 0x0DA6, 0xAB0D, 0x0DAB, 0xAF0D,
	0x0DAF, 0xB40D, 0x0DB4, 0xB90D, 0x0DB9, 0xBD0D, 0x0DBD, 0xC20D, 0x0DC2, 0xC60D,
	0x0DC6, 0xCB0D, 0x0DCB, 0xCF0D, 0x0DCF, 0xD40D, 0x0DD4, 0xD80D, 0x0DD8, 0xDD0D,
	0x0DDD, 0xE10D, 0x0DE1, 0xE60D, 0x0DE6, 0xEA0D, 0x0DEA, 0xEF0D, 0x0DEF, 0xF30D,
	0x0DF3, 0xF80D, 0x0DF8, 0xFC0D, 0x0DFC, 0x010D, 0x0E01, 0x050E, 0x0E05, 0x0A0E,
	0x0E0A, 0x0F0E, 0x0E0F, 0x130E, 0x0E13, 0x180E, 0x0E18, 0x1C0E, 0x0E1C, 0x210E,
	0x0E21, 0x250E, 0x0E25, 0x2A0E, 0x0E2A, 0x2E0E, 0x0E2E, 0x330E, 0x0E33, 0x370E,
	0x0E37, 0x3C0E, 0x0E3C, 0x400E, 0x0E40, 0x450E, 0x0E45, 0x490E, 0x0E49, 0x4E0E,
	0x0E4E, 0x520E, 0x0E52, 0x560E, 0x0E56, 0x5B0E, 0x0E5B, 0x5F0E, 0x0E5F, 0x640E,
	0x0E64, 0x680E, 0x0E68, 0x6D0E, 0x0E6D, 0x710E, 0x0E71, 0x760E, 0x0E76, 0x7A0E,
	0x0E7A, 0x7F0E, 0x0E7F, 0x830E, 0x0E83, 0x880E, 0x0E88, 0x8C0E, 0x0E8C, 0x910E,
	0x0E91, 0x950E, 0x0E95, 0x9A0E, 0x0E9A, 0x9E0E, 0x0E9E, 0xA30E, 0x0EA3, 0xA70E,
	0x0EA7, 0xAC0E, 0x0EAC, 0xB00E, 0x0EB0, 0xB40E, 0x0EB4, 0xB90E, 0x0EB9, 0xBD0E,
	0x0EBD, 0xC20E, 0x0EC2, 0xC60E, 0x0EC6, 0xCB0E, 0x0ECB, 0xCF0E, 0x0ECF, 0xD40E,
	0x0ED4, 0xD80E, 0x0ED8, 0xDC0E, 0x0EDC, 0xE10E, 0x0EE1, 0xE50E, 0x0EE5, 0xEA0E,
	0x0EEA, 0xEE0E, 0x0EEE, 0xF30E, 0x0EF3, 0xF70E, 0x0EF7, 0xFC0E, 0x0EFC, 0x000E,
	0x0F00, 0x040F, 0x0F04, 0x090F, 0x0F09, 0x0D0F, 0x0F0D, 0x120F, 0x0F12, 0x160F,
	0x0F16, 0x1B0F, 0x0F1B, 0x1F0F, 0x0F1F, 0x230F, 0x0F23, 0x280F, 0x0F28, 0x2C0F,
	0x0F2C, 0x310F, 0x0F31, 0x350F, 0x0F35, 0x3A0F, 0x0F3A, 0x3E0F, 0x0F3E, 0x420F,
	0x0F42, 0x470F, 0x0F47, 0x4B0F, 0x0F4B, 0x500F, 0x0F50, 0x540F, 0x0F54, 0x580F,
	0x0F58, 0x5D0F, 0x0F5D, 0x610F, 0x0F61, 0x660F, 0x0F66, 0x6A0F, 0x0F6A, 0x6E0F,
	0x0F6E, 0x730F, 0x0F73, 0x770F, 0x0F77, 0x7C0F, 0x0F7C, 0x800F, 0x0F80, 0x840F,
	0x0F84, 0x890F, 0x0F89, 0x8D0F, 0x0F8D, 0x910F, 0x0F91, 0x960F, 0x0F96, 0x9A0F,
	0x0F9A, 0x9F0F, 0x0F9F, 0xA30F, 0x0FA3, 0xA70F, 0x0FA7, 0xAC0F, 0x0FAC, 0xB00F,
	0x0FB0, 0xB50F, 0x0FB5, 0xB90F, 0x0FB9, 0xBD0F, 0x0FBD, 0xC20F, 0x0FC2, 0xC60F,
	0x0FC6, 0xCA0F, 0x0FCA, 0xCF0F, 0x0FCF, 0xD30F, 0x0FD3, 0xD70F, 0x0FD7, 0xDC0F,
	0x0FDC, 0xE00F, 0x0FE0, 0xE50F, 0x0FE5, 0xE90F, 0x0FE9, 0xED0F, 0x0FED, 0xF20F,
	0x0FF2, 0xF60F, 0x0FF6, 0xFA0F, 0x0FFA, 0xFF0F, 0x0FFF, 0x030F, 0x1003, 0x0710,
	0x1007, 0x0C10, 0x100C, 0x1010, 0x1010, 0x1410, 0x1014, 0x1910, 0x1019, 0x1D10,
	0x101D, 0x2110, 0x1021, 0x2610, 0x1026, 0x2A10, 0x102A, 0x2E10, 0x102E, 0x3310,
	0x1033, 0x3710, 0x1037, 0x3B10, 0x103B, 0x4010, 0x1040, 0x4410, 0x1044, 0x4810,
	0x1048, 0x4D10, 0x104D, 0x5110, 0x1051, 0x5510, 0x1055, 0x5A10, 0x105A, 0x5E10,
	0x105E, 0x6210, 0x1062, 0x6710, 0x1067, 0x6B10, 0x106B, 0x6F10, 0x106F, 0x7310,
	0x1073, 0x7810, 0x1078, 0x7C10, 0x107C, 0x8010, 0x1080, 0x8510, 0x1085, 0x8910,
	0x1089, 0x8D10, 0x108D, 0x9210, 0x1092, 0x9610, 0x1096, 0x9A10, 0x109A, 0x9E10,
	0x109E, 0xA310, 0x10A3, 0xA710, 0x10A7, 0xAB10, 0x10AB, 0xB010, 0x10B0, 0xB410,
	0x10B4, 0xB810, 0x10B8, 0xBC10, 0x10BC, 0xC110, 0x10C1, 0xC510, 0x10C5, 0xC910,
	0x10C9, 0xCE10, 0x10CE, 0xD210, 0x10D2, 0xD610, 0x10D6, 0xDA10, 0x10DA, 0xDF10,
	0x10DF, 0xE310, 0x10E3, 0xE710, 0x10E7, 0xEB10, 0x10EB, 0xF010, 0x10F0, 0xF410,
	0x10F4, 0xF810, 0x10F8, 0xFD10, 0x10FD, 0x0110, 0x1101, 0x0511, 0x1105, 0x0911,
	0x1109, 0x0E11, 0x110E, 0x1211, 0x1112, 0x1611, 0x1116, 0x1A11, 0x111A, 0x1F11,
	0x111F, 0x2311, 0x1123, 0x2711, 0x1127, 0x2B11, 0x112B, 0x3011, 0x1130, 0x3411,
	0x1134, 0x3811, 0x1138, 0x3C11, 0x113C, 0x4011, 0x1140, 0x4511, 0x1145, 0x4911,
	0x1149, 0x4D11, 0x114D, 0x5111, 0x1151, 0x5611, 0x1156, 0x5A11, 0x115A, 0x5E11,
	0x115E, 0x6211, 0x1162, 0x6611, 0x1166, 0x6B11, 0x116B, 0x6F11, 0x116F, 0x7311,
	0x1173, 0x7711, 0x1177, 0x7C11, 0x117C, 0x8011, 0x1180, 0x8411, 0x1184, 0x8811,
	0x1188, 0x8C11, 0x118C, 0x9111, 0x1191, 0x9511, 0x1195, 0x9911, 0x1199, 0x9D11,
	0x119D, 0xA111, 0x11A1, 0xA611, 0x11A6, 0xAA11, 0x11AA, 0xAE11, 0x11AE, 0xB211,
	0x11B2, 0xB611, 0x11B6, 0xBB11, 0x11BB, 0xBF11, 0x11BF, 0xC311, 0x11C3, 0xC711,
	0x11C7, 0xCB11, 0x11CB, 0xCF11, 0x11CF, 0xD411, 0x11D4, 0xD811, 0x11D8, 0xDC11,
	0x11DC, 0xE011, 0x11E0, 0xE411, 0x11E4, 0xE911, 0x11E9, 0xED11, 0x11ED, 0xF111,
	0x11F1, 0xF511, 0x11F5, 0xF911, 0x11F9, 0xFD11, 0x11FD, 0x0211, 0x1202, 0x0612,
	0x1206, 0x0A12, 0x120A, 0x0E12, 0x120E, 0x1212, 0x1212, 0x1612, 0x1216, 0x1A12,
	0x121A, 0x1F12, 0x121F, 0x2312, 0x1223, 0x2712, 0x1227, 0x2B12, 0x122B, 0x2F12,
	0x122F, 0x3312, 0x1233, 0x3712, 0x1237, 0x3C12, 0x123C, 0x4012, 0x1240, 0x4412,
	0x1244, 0x4812, 0x1248, 0x4C12, 0x124C, 0x5012, 0x1250, 0x5412, 0x1254, 0x5912,
	0x1259, 0x5D12, 0x125D, 0x6112, 0x1261, 0x6512, 0x1265, 0x6912, 0x1269, 0x6D12,
	0x126D, 0x7112, 0x1271, 0x7512, 0x1275, 0x7A12, 0x127A, 0x7E12, 0x127E, 0x8212,
	0x1282, 0x8612, 0x1286, 0x8A12, 0x128A, 0x8E12, 0x128E, 0x9212, 0x1292, 0x9612,
	0x1296, 0x9A12, 0x129A, 0x9F12, 0x129F, 0xA312, 0x12A3, 0xA712, 0x12A7, 0xAB12,
	0x12AB, 0xAF12, 0x12AF, 0xB312, 0x12B3, 0xB712, 0x12B7, 0xBB12, 0x12BB, 0xBF12,
	0x12BF, 0xC312, 0x12C3, 0xC712, 0x12C7, 0xCC12, 0x12CC, 0xD012, 0x12D0, 0xD412,
	0x12D4, 0xD812, 0x12D8, 0xDC12, 0x12DC, 0xE012, 0x12E0, 0xE412, 0x12E4, 0xE812,
};

int dword_AD920 = 0;
int dword_A33F6 = 0;
char dword_A33F5 = 0;
int dword_A5EE0 = 0;

void LOAD_VSyncHandler()//5F074(<), 5FD54(<)
{
	int a0, a1, a2;
	if (LtLoadingBarEnabled != 0)
	{
		//loc_5F08C
		GPU_BeginScene();

		a0 = 0x1B8;
		a1 = 0xC8;
		a2 = 0x40;

		if (_first_time_ever)
		{
			a0 += 0x18;
			a1 += 8;
			a2 = 0x30;
		}

		//loc_5F0B4
		//draw_rotate_sprite(a0, a1, a2);
		db.current_buffer ^= 1;
		GnLastFrameCount = 0;
		//DrawOTagEnv(&db.ot[db.nOTSize - 1], &db.draw[0]);
	}

	return;
}

void LOAD_DrawEnable(unsigned char isEnabled)//5F2C8, 5FFA8
{
	LtLoadingBarEnabled = isEnabled;
}

void LOAD_Start(int file_number)//602AC, 60DEC(<)
{
	unsigned long* tmpptr = NULL;
	char* gfx = NULL;
	unsigned short* cdgfx = NULL;
	unsigned short* gfx2 = NULL;
	int fileSize, x, y, i;
	unsigned short dat;

#ifdef PSX_VERSION
	//jal sub_6B144 //DrawSync(0);
	//jal sub_6A1FC //VSync(0);
	//jal sub_5F1C8 //GPU_UseOrderingTables(dword_AD920);
#endif

	db.draw[0].isbg = 0;
	db.draw[1].isbg = 0;
	db.draw[0].dtd = 0;
	db.draw[1].dtd = 0;

#ifdef PSX_VERSION
	//jal sub_6B440 //PutDispEnv(&db.draw[0]);
#endif

	//?
	dword_A5EE0 = 0;

	//We're going to allocate enough memory for the loading screen background picture and loading disc image
	//The result pointer is later used as the base to read the loading screen/disc bitmap from GAMEWAD.OBJ on disk.
	gfx = game_malloc(LOADING_SCREEN_IMG_SIZE + LOADING_CD_IMG_SIZE);
	if (dword_A33F6 == 0)
	{
		//assert(0);
	}

	//UNKNOWN_41 is the first loading screen image, simply add Gameflow->Language to the base to load language specific load screens.
	fileSize = CD_InitialiseReaderPosition(UNKNOWN_41 + Gameflow->Language);

	//Request the loading screen/disc bitmaps to be read into gfx ptr.
	//We don't actually pass the file ID or offset since this is already cached by the previous GAMEWAD_InitialiseFileEntry call.
	CD_Read(fileSize, gfx);

	//TITLE is the base file entry index for levels, simply as a result, we must add gameflow level id to this.
	CD_InitialiseReaderPosition(file_number + TITLE);

	//We will skip past the loading screen and disc image data so on the next read call we're ready to read SETUP.MOD
	CD_Seek(LOADING_SCREEN_IMG_SIZE + LOADING_CD_IMG_SIZE);

	//Why?
	tmpptr = (unsigned long*) gfx;
	for (i = 0; i < LOADING_SCREEN_IMG_SIZE / sizeof(unsigned long); i++)
	{
		tmpptr[i] |= (SHRT_MAX + 1) << 16 | (SHRT_MAX + 1);
	}

#ifdef PSX_VERSION
	//jal sub_6B1C4 //StoreImage(); //frame buffer (gfx, LOADING_SCREEN_IMG_SIZE)
	//jal sub_6B144 //DrawSync();
#endif

	cdgfx = (unsigned short*)(gfx + LOADING_SCREEN_IMG_SIZE);
	gfx2 = (unsigned short*)gfx;

	//Why?
	for (x = 0; x < LOADING_CD_IMG_WIDTH; x++, gfx2 += (LOADING_SCREEN_IMG_WIDTH + LOADING_CD_IMG_WIDTH + 60) / sizeof(unsigned short))
	{
		for (y = 0; y < LOADING_CD_IMG_HEIGHT; y++, cdgfx++, gfx2++)
		{
			dat = *cdgfx;

			if (dat == 0)
			{
				dat = (SHRT_MAX + 1);
			}

			if (dat == 0xFC1F)
			{
				*gfx2 = 0;
			}
		}
	}

	//int a0 = 0xA5FD0;//pScreenDimensions {shrt unk, shrt h, shrt w}
	//jal sub_6B1C4 //StoreImage(s2); frame buffer
	//sub_6B144 //DrawSync(0);

	game_free(LOADING_SCREEN_IMG_SIZE + LOADING_CD_IMG_SIZE);

	LOAD_DrawEnable(1);

	dword_A33F5 = 1;
}

void LOAD_Stop()//60434(<), 60FB4(<) (F)
{
	LOAD_DrawEnable(0);

	LoadingBarEnabled = 0;

	db.draw[1].isbg = 1;
	db.draw[0].isbg = 1;
	db.draw[1].dtd = 1;
	db.draw[0].dtd = 1;

	GPU_UseOrderingTables(&GadwOrderingTables[0], 2564);
	db.current_buffer = 0;

	GPU_SyncBothScreens();
	db.current_buffer = 1;

#ifdef INTERNAL
	ProfileDraw = 1;
	_first_time_ever = 0;
#endif
}